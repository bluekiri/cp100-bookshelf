
<!doctype html>

<html>
<head>
  <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">
  <meta name="theme-color" content="#4F7DC9">
  <meta charset="UTF-8">
  <title>BLUEKIRI - Demo GCP App Engine with Python</title>
  <script src="../../bower_components/webcomponentsjs/webcomponents-lite.js"></script>
  <link rel="import" href="../../elements/codelab.html">
  <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Source+Code+Pro:400|Roboto:400,300,400italic,500,700|Roboto+Mono">
  <style is="custom-style">
    body {
      font-family: "Roboto",sans-serif;
      background: var(--google-codelab-background, --paper-grey-300);
    }
  </style>
  
</head>
<body unresolved class="fullbleed">

  <google-codelab title="BLUEKIRI - Demo GCP App Engine with Python"
                  environment="web"
                  feedback-link="">
    
      <google-codelab-step label="Introduction" duration="0">
        <p>App Engine is a managed computing environment that lets you focus on writing and running code. As you see in this lab, you do not need to create, configure, or manage any servers, storage, or networks to get started. App Engine handles all of the web traffic generated by your users and automatically scales to meet changes in traffic levels.</p>
<h2><strong>What you will build</strong></h2>
<p>Bookshelf is a simple Python web application that lets users create and manage a list of books. The application uses the <a href="http://flask.pocoo.org/" target="_blank">Flask</a> web microframework to coordinate reading and writing to storage. You can also use a variety of other frameworks to build Python applications on App Engine, including <a href="https://cloud.google.com/appengine/docs/python/tools/webapp2" target="_blank">webapp2</a>, and <a href="https://www.djangoproject.com/" target="_blank">Django</a>.</p>
<p><img style="max-width: 622.00px" src="img/d5a8e785788d0b8.png"></p>
<h2 class="checklist"><strong>What you&#39;ll learn</strong></h2>
<ul class="checklist">
<li>Deploy a sample Python application called Bookshelf to the App Engine standard runtime environment</li>
<li>Test the Bookshelf application and inspect data saved to Cloud Datastore</li>
</ul>


      </google-codelab-step>
    
      <google-codelab-step label="Get the source code" duration="0">
        <h2><strong>Step 1</strong></h2>
<p>Open the Google Cloud Platform Console, and if necessary, select the &#34;demo-gcp&#34; project.</p>
<p>Previously, we have created a repository called default with the solution.</p>
<aside class="warning"><p><strong>NOTE</strong>: First, check if application is enabled. To do this, go to <strong>App Engine</strong> &gt; <strong>Settings</strong> (bottom left menu option) - click <strong>Enable application</strong>.</p>
</aside>
<h2><strong>Step 2</strong></h2>
<p>In the top right corner of the console window, click the Activate Google Cloud Shell button (<img style="max-width: 19.00px" src="img/2f6b3347d4d0ebfd.png">).</p>
<h2><strong>Step 3</strong></h2>
<p>Create a directory for the repository (check if you have created before. In this case, remove the folder)</p>
<pre>mkdir cp100</pre>
<h2><strong>Step 4</strong></h2>
<p>Change to the new folder</p>
<pre>cd cp100</pre>
<h2><strong>Step 5</strong></h2>
<p>Clone the repo</p>
<pre>gcloud source repos clone default</pre>
<h2><strong>Step 6</strong></h2>
<p>Change to the App Engine folder</p>
<p>~/cp100/default/app-engine</p>


      </google-codelab-step>
    
      <google-codelab-step label="Review the application" duration="0">
        <h2><strong>Step 1</strong></h2>
<p>In the top right corner of the Google Cloud Shell, click over &#34;Launch code editor&#34; button (<img style="max-width: 21.00px" src="img/62863f3a5ae0c0cf.png">).</p>
<p>You are presented with a list of directory and file names that make up the source code for this lab.</p>
<ul>
<li>bookshelf</li>
<li>app.yaml</li>
<li>appengine_config.py</li>
<li>config.py</li>
<li>main.py</li>
<li>requirements.txt</li>
</ul>
<h2><strong>Step 2</strong></h2>
<p>Click <strong>app.yaml</strong>.</p>
<p>An App Engine app.yaml configuration file includes a variety of configuration data as required, and optional elements, used to deploy and manage the behavior of your application.</p>
<p>Note in particular, on <strong>line 19</strong> that the application runtime is set to Python version 2.7.</p>
<p>Also note, that <strong>lines 23 through 25</strong> define the only script handler for this application, that describes how all requests to the application (/.* indicates all requests), should be handled by main.app. A mapping typically defines a URL pattern to match, and the script to be executed. </p>
<h2><strong>Step 3</strong></h2>
<p>Click <strong>main.py</strong>. </p>
<p>This file imports the bookshelf code and loads any relevant configuration data into the application.</p>
<h2><strong>Step 4</strong></h2>
<p>Click <strong>config.py</strong>. </p>
<p>This file is used to manage configuration data that is specific to your project and copy of the application.</p>
<h2><strong>Step 5</strong></h2>
<p>Click <strong>/ &gt; app-engine &gt; bookshelf</strong>. </p>
<p>You are presented with another list of directory and file names that make up the source code for the Bookshelf application.</p>
<ul>
<li><strong>templates</strong> - Contains HTML files that define the view, or user interface (UI) layer of the application</li>
<li><strong>__init__.py</strong> - Initalizes the Flask web microframework, loads the storage library and routes requests to the correct part of the application</li>
<li><strong>crud.py</strong> - Acts as a controller layer </li>
<li><strong>model_cloudsql.py</strong> - Includes code used to read and write data using Cloud SQL (not currently used in this demo)</li>
<li><strong>model_datastore.py</strong> - Includes code used to read and write data using Cloud Datastore, the storage layer of the application</li>
</ul>


      </google-codelab-step>
    
      <google-codelab-step label="Deploy the application" duration="0">
        <h2><strong>Step 1</strong></h2>
<p>Return to Cloud Shell and make sure to change to the directory containing the code</p>
<pre>cd ~/cp100/default/app-engine</pre>
<h2><strong>Step 2</strong></h2>
<p>To run the application, we need to install a number of third-party libraries that the Bookshelf application uses</p>
<pre>cat requirements.txt</pre>
<h2><strong>Step 3</strong></h2>
<p>Download the dependencies before deploy the application in the folder <strong>lib</strong> (libraries you installed are loaded from the lib directory using the code in <strong>appengine_config.py </strong>that App Engine automatically loads when a new instance of your application is started)</p>
<pre>pip install -r requirements.txt -t lib</pre>
<h2><strong>Step 4</strong></h2>
<p>Type the following command to deploy the application</p>
<pre>gcloud app deploy</pre>
<p>The system asks you into which GCP region you want to deploy your application (11 for europe west).</p>
<p>You are asked to confirm that you want to proceed with the deployment. Type Y and press return.</p>
<h2><strong>Step 5</strong></h2>
<p>You can now visit and test the deployed Bookshelf application.</p>
<p>In the Cloud Platform Console, click <strong>Compute &gt; App Engine</strong>.</p>
<p>In the top right-hand corner of the Dashboard, click the link to your deployed application. The link takes the format:</p>
<p><strong>&lt;project-id&gt;.appspot.com</strong></p>
<p>The Bookshelf application loads in a new browser tab.</p>
<aside class="special"><p>Alternatively, you can execute <strong>gcloud app browse</strong> in Cloud Console to obtain the url of the application.</p>
</aside>


      </google-codelab-step>
    
      <google-codelab-step label="Deploy the application" duration="0">
        <h2><strong>Step 1</strong></h2>
<p>When Bookshelf is first deployed, there is no test data included. To begin exploring the application click Add book.</p>
<h2>Step 2</h2>
<p>On the â€˜Add book&#39; page:</p>
<ul>
<li>For <strong>Title</strong>, type &lt;Title&gt;.</li>
<li>For <strong>Author</strong>, type &lt;Book&gt;.</li>
<li>For <strong>Date Published</strong>, type &lt;today&gt;.</li>
<li>For <strong>Description</strong>, type &lt;Description&gt;.</li>
<li>Click Save.</li>
</ul>


      </google-codelab-step>
    
      <google-codelab-step label="Update the application (opt)" duration="0">
        <h2><strong>Step 1</strong></h2>
<p>We are going to update our application. Go to the Code Editor and open ~/cp100/default/app-engine/template/base.html and modify the title section. Finally, save the file.</p>
<aside class="warning"><p>Don&#39;t update the code repository.</p>
</aside>
<h2><strong>Step 2</strong></h2>
<p>Update the application</p>
<pre>gcloud app deploy</pre>
<h2><strong>Step 3</strong></h2>
<p>We are going to update our application but now we are going to split traffic to check the new version. Go to the Code Editor and open ~/cp100/default/app-engine/template/base.html and modify the title section another time. Finally, save the file.</p>
<h2><strong>Step 4</strong></h2>
<p>Update the application</p>
<pre>gcloud app deploy --no-promote</pre>
<p>Go to Google Console, <strong>App Engine</strong> &gt; <strong>Versions</strong> and check the generated versions</p>
<p><img style="max-width: 624.00px" src="img/ad25f80b8cfbbcce.png"></p>
<aside class="special"><p>If you click over the last version, you can validate the changes before go live.</p>
</aside>
<p>Click over <strong>Split Traffic</strong>. Click over <strong>Add version</strong> and select the new version and split the traffic between the versions (select <strong>Random</strong> option) and finally click <strong>Save</strong>.</p>
<p><img style="max-width: 479.00px" src="img/a33d25dfd47c8a4e.png"></p>
<p>Go to the browser and update several times the home page to see the new version.</p>
<p>Finally send all the traffic to the new version.</p>


      </google-codelab-step>
    
      <google-codelab-step label="Clean up solution" duration="0">
        <p>First realize that you can&#39;t completely delete an App Engine application like you can a Compute Engine instance, by design.</p>
<p><strong>Choice 1</strong>: you can disable the application, effectively shutting it off. To do this, go to <strong>App Engine</strong> &gt; <strong>Settings</strong> (bottom left menu option) - click <strong>Disable application</strong>. You won&#39;t be billed for resources used for App Engine, however any storage resources in use will still be billed.</p>
<p><strong>Choice 2</strong>: To completely delete the entirety of your App Engine project, shut down the entire project it is hosted in.</p>


      </google-codelab-step>
    
  </google-codelab>

  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
    ga('create', 'UA-49880327-14', 'auto');

    (function() {
      var gaCodelab = '';
      if (gaCodelab) {
        ga('create', gaCodelab, 'auto', {name: 'codelab'});
      }

      var gaView;
      var parts = location.search.substring(1).split('&');
      for (var i = 0; i < parts.length; i++) {
        var param = parts[i].split('=');
        if (param[0] === 'viewga') {
          gaView = param[1];
          break;
        }
      }
      if (gaView && gaView !== gaCodelab) {
        ga('create', gaView, 'auto', {name: 'view'});
      }
    })();
  </script>

</body>
</html>
